<script type="text/javascript">
	// Ontology id
	jQuery.data(document.body, "ontology_id", "<%= @ontology.ontologyId %>");

	// Load external JS files
	if (typeof BP_NOTES_THREAD_LOADED == 'undefined') jQuery.getScript("/javascripts/bp_notes_thread.js?update");
</script>

<% if @notes.nil? %>

	No notes to display.

<% else %>

<div id="<%= @notes.id %>" class="data_div">
	<div id="<%= @notes.id %>_head" class="note_head">
    <% if !session[:user].nil? && (session[:user].id.to_i.eql?(@ontology.userId.to_i) || session[:user].admin?) %>
      <div style="float: right; text-align: right;">
        <form id="<%= @notes.id %>_archive_note_form">
          <input type="hidden" value="<%= @notes.id %>" name="note_id">
          <input type="hidden" value="<%= @notes.archived %>" name="archived">
          <input type="hidden" value="<%= @ontology.ontologyId %>" name="ontology_id">
          <input type="button" class="archive_note" id="<%= @notes.id %>_archive" name="<%= @notes.id %>_archive" value="<%if @notes.archived.eql?("true")%>Unarchive<%else%>Archive<%end%> Note"><span id="<%= @notes.id %>_archive_spinner" style="display: none;">
          <img src="/images/tree/spinner.gif" style="vertical-align: text-bottom;" /> <span id="<%=@notes.id%>_spinner_text"><%if @notes.archived.eql?("true")%>Unarchiving<%else%>Archiving<%end%>...</span></span>
        </form>
      </div>
    <% end %>
    
		<div id="<%= @notes.id %>_title" class="note_title">
			<%= @notes.subject %> &nbsp;&nbsp;&nbsp;&nbsp;<span id="<%= @notes.id %>_title_archived" style="color: grey; font-size: 12pt;"><%if @notes.archived.eql?("true")%>archived<%end%></span>
		</div>
		
		<div id="<%= @notes.id %>_status" class="note_status">
			<!-- Status: <span id="status"><% "TODO: Status" %></span><br/> -->
			<%= get_note_type_text(@notes.type) %> submitted by <span id="<%= @notes.id %>_author" class="note_author"><%= get_username(@notes.author) %></span> <%= time_ago_in_words(Time.at(convert_java_time(@notes.created.to_i))) %> ago
			on <%= get_applies_to_link @notes.createdInOntologyVersion, @notes.appliesTo['type'], @notes.appliesTo['id'] %> <%="in <a href='/ontologies/#{@ontology.id}'>#{@ontology.displayLabel}</a>" if @ontology%>
		</div>
	</div>
	
	<% proposal_info = proposal_html(@notes) %>
	
	<div class="proposal_root" <%= "style='display: none;'" if proposal_info.nil? or proposal_info.empty? %>>
		<%= proposal_info %>
	</div>
	
	<div id="<%= @notes.id %>_body" class="note_body">
		<%= @notes.body %>
	</div>
		
	<div class="divider">&nbsp;</div>
	
	<% unless @notes.associated.nil? || @notes.associated.empty? %>
		<div id="<%= @notes.id %>_responses_container" class="responses_container">
			<div id="<%= @notes.id %>_responses_head" class="responses_head">
				<span class="section_head"><%= @notes_thread_title %></span> &nbsp;&nbsp;<span style="font-size: 80%;"> <a id="<%= @notes.id %>_hide_all_responses" class="hide_all_responses" href="javascript:void(0)">hide all</a> | <a id="<%= @notes.id %>_show_all_responses" class="show_all_responses" href="javascript:void(0)">show all</a></span>
			</div>
			<%= generate_notes_thread(@notes.associated, :root_id => @notes.id) %>
		</div> 
	<% else %>
		<div id="<%= @notes.id %>_responses_container" class="responses_container" style="display: none;">
			<div id="<%= @notes.id %>_responses_head" class="responses_head">
				<span class="section_head"><%= @notes_thread_title %></span> &nbsp;&nbsp;<span style="font-size: 80%;"> <a id="<%= @notes.id %>_hide_all_responses" class="hide_all_responses" href="javascript:void(0)">hide all</a> | <a id="<%= @notes.id %>_show_all_responses" class="show_all_responses" href="javascript:void(0)">show all</a></span>
			</div>
		</div> 
	<% end %>
	
	<div id="top_level_reply">
		<% applies_to = @notes.id %>
		<% applies_to_type = "Note" %>
		<%= render :partial => 'add', :locals => { :applies_to => applies_to, :applies_to_type => applies_to_type, :action => 'root', :add_text => "Add Reply" } %>
	</div>
	
	<div style="display: none;">
		<div id="<%= @notes.id %>_hidden_form">
			<%= render :partial => 'add', :locals => { :applies_to => applies_to, :applies_to_type => applies_to_type, :exclude_js => true, :action => 'thread', :dummy_add => true, :add_text => "Add Reply" } %>
		</div>
		<script type="text/javascript">
			// Tricky. We're going to use the div hidden_form to get the html for a form we use later. 
			if (typeof cache.reply_form === 'undefined') {
				cache.reply_form = jQuery("#<%= @notes.id %>_hidden_form").html();
			}
			// Always remove the extra form
			jQuery("#<%= @notes.id %>_hidden_form").html("");
		</script>
	</div>
</div>

<% end %>