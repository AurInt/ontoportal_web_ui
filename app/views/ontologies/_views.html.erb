<script type="text/javascript">
  jQuery(document).ready(function(){
    jQuery(".click_view_collapse").click(function(){
      var collapse = "#" + jQuery(this).parent().attr("id") + "_collapsible";
      var icon = "#" + jQuery(this).parent().attr("id") + "_icon";
      jQuery(icon).toggleClass("ui-icon-triangle-1-e");
      jQuery(icon).toggleClass("ui-icon-triangle-1-s");
      jQuery(collapse).toggle();
    });

    jQuery("#expand_views").click(function(){
      jQuery(".view_collapsible").show();
      jQuery(".click_view_collapse_icon").removeClass("ui-icon-triangle-1-e");
      jQuery(".click_view_collapse_icon").addClass("ui-icon-triangle-1-s");
    });

    jQuery("#collapse_views").click(function(){
      jQuery(".view_collapsible").hide();
      jQuery(".click_view_collapse_icon").removeClass("ui-icon-triangle-1-s");
      jQuery(".click_view_collapse_icon").addClass("ui-icon-triangle-1-e");
    });
  });
</script>


<div style="clear: both;"></div>
<div id="views_content">
  <h2 style="margin: 2em 0 0">
    <span style="font-size: x-large; margin-right: 1.5em;">Views</span>
    <%if session[:user].nil? %>
      <a href="/login?redirect=<%=URI.escape("/ontologies/view/new?version_id=#{@ontology.id}")%>">Create new view</a>
    <%else %>
      <a href="/ontologies/view/new?version_id=<%=@ontology.id%>">Create new view</a>
    <%end %>
  </h2>

    <div style="float:left;">
      <%if @ontology.views.empty? || @ontology.views.first.size < 1 %>
        <h1>No views available.</h1>
      <%else %>

      <h4 style="margin-top: .5em;"><a href="javascript:void(0);" id="expand_views">Expand All</a>  |  <a href="javascript:void(0);" id="collapse_views">Collapse All</a></h4>

      <% @ontology.views.each_with_index do |virtual, index| %>
        <%if virtual[0].nil?
            next
         else
             virt0 = virtual[0]
         end%>

        <style type="text/css">
          #view_head .lead {
            color: #708090;
            font-weight: bold;
          }
          .view_collapsible {
            margin: 0 1em;
          }
          .click_view_collapse:hover {
            text-decoration: underline;
          }
        </style>

        <div id="view_<%=index%>" class="view_title" style="margin: 1em 0 .5em; cursor: pointer;" >
          <span id="view_<%=index%>_icon" class="ui-icon ui-icon-triangle-1-e click_view_collapse click_view_collapse_icon" style="float: left;"></span>
          <span class="click_view_collapse" style="font-size: 120%; font-weight: bold;"><%= virt0.displayLabel %></span>
          <span style="font-size: 90%;">
            <%if virt0.admin?(session[:user]) %>
               <span style="padding-left: 1em; vertical-align: text-bottom;">(<%= link_to "Edit Metadata", "/ontologies/view/edit/#{virt0.id}" %>)</span>
            <%end%>
          </span>
        </div>

        <div id="view_<%=index%>_collapsible" class="view_collapsible" style="margin: 0 1em .5em; display: none;">
          <div id="view_head" style="margin: 0 0 .5em;" class="enable-lists">
            <ul>
                <li>
                    <span class="lead">Description:</span> <%=virt0.description %>
                </li>
                <% unless virt0.viewDefinition.empty? %>
                    <li>
                        <span class="lead">Definition:</span> <%=virt0.viewDefinition %>
                    </li>
                <%end%>
                <li>
                    <span class="lead">Ontology ID:</span> <%=virt0.ontologyId %>
                </li>
                <% unless virt0.viewGenerationEngine.empty? %>
                    <li><span class="lead">Generation Engine:</span> <%=virt0.viewGenerationEngine %>
                        
                    </li>
                <%end%>
                <% unless virt0.viewDefinitionLanguage.empty? %>
                    <li>
                        <span class="lead">Definition Language:</span> <%=virt0.viewDefinitionLanguage %>
                    </li>
                <%end%>
                <li>
                    <span class="lead">Created By:</span>
                    <% contact_name = virt0.contactName.nil? || virt0.contactName.empty? ? "" : virt0.contactName + ", " %>
                    <%= contact_name + virt0.contactEmail %>
                </li>
            </ul>
          </div>

              <table class="zebra" cellpadding="0" cellspacing="0" width="100%">
                  <thead>
                      <tr>
                          <th>
                              Version
                          </th>
                          <th>
                              Ontology Version
                          </th>
                          <th>
                              Release Date
                          </th>
                          <th>
                              Upload Date
                          </th>
                          <th>
                              Downloads
                          </th>
                      </tr>
                  </thead>
                  <%
                  virtual.sort!{|x,y| y.internalVersion<=>x.internalVersion}
                  virtual.each_with_index do |view, view_index|  %>
                  <tr>
                      <%#= debug view %>
                      <td>
                        <a href="/ontologies/<%=view.id%>?p=terms"><%=view.versionNumber%></a>
                      </td>
                      <td>
                        <% ontVer = get_view_ontology_version(view.viewOnOntologyVersionId) rescue "unknown"%>
                        <a href="/ontologies/<%=view.viewOnOntologyVersionId%>?p=terms"><%=ontVer%></a>
                      </td>
                      <td>
                          <%= view.dateReleased %>
                      </td>
                      <td>
                          <%= view.dateCreated %>
                      </td>
                      <td>
                          <a href="<%=DataAccess.download(view.id)%>" target="_blank">Ontology View</a>
                      </td>
                      <!--
                          <%#= get_diffs_link(view.diffs, view.versions_array, view, view_index) rescue ""%>
                          <%#= visibility_link(view) %>
                      -->
                  </tr>
                  <%end %>
                <%if virt0.admin?(session[:user]) %>
                    <tr><td colspan=7>
                        <h3 style="margin-bottom: 0;">
                            <a href="/ontologies/view/new/<%=virt0.id%>?version_id=<%=@ontology.id%>">Submit New View Version</a>
                        </h3>
                    </td></tr>
                <%end %>
              </table>
     </div> <!-- collapsible div -->
           <%end %>
          <%end %>
    </div>
</div>
