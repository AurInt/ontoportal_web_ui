(function(a){a.fn.NCBOTree=function(c){var f="roots";var b=this;var d=a("<ul>").append(a("<li>").addClass("root"));var e;var g=false;d.option={autoclose:false,beforeExpand:false,afterExpand:false,afterExpandError:false,afterSelect:false,afterJumpToClass:false,timeout:999999,treeClass:"ncboTree",autocompleteClass:"ncboAutocomplete",width:350,ncboAPIURL:"http://data.bioontology.org",ncboUIURL:"http://bioportal.bioontology.org",apikey:null,ontology:null,startingClass:null,startingRoot:f,defaultRoot:f};d.option=a.extend(d.option,c);if(d.option.apikey==null){throw new Error("You must provide an API Key for NCBO Tree Widget to operate")}if(d.option.ontology==null){throw new Error("You must provide an ontology id for NCBO Tree Widget to operate")}a.extend(this,{selectedClass:function(){var h=a(a(this).find("a.active")[0]);if(h.length==0){return null}else{return{id:decodeURIComponent(h.data("id")),prefLabel:h.html(),URL:h.attr("href")}}},selectClass:function(h){var i=a(a(this).find("a[data-id='"+encodeURIComponent(h)+"']"));a(a(this).find("a.active")[0]).removeClass("active");i.addClass("active")},jumpToClass:function(h,i){d.jumpToClass(h,i)},changeOntology:function(h){var i=a("<ul>").append(a("<li>").addClass("root"));setupTree(b,i,d.option);d.option.ontology=h;d.init()}});setupTree=function(i,h,k){d=h;d.option=k;e=a(".root",d);d.css("width",d.option.width);a(b).html("");var l=(d.option.startingRoot==d.option.defaultRoot)?null:d.option.startingRoot;var m=a("<div>").addClass(d.option.autocompleteClass).addClass("ncboTree");var j=a("<input>").addClass(d.option.autocompleteClass).css("width",d.option.width).attr("placeholder","Search for class...");m.append(j);j.NCBOAutocomplete({url:d.option.ncboAPIURL+"/search",searchParameter:"q",resultAttribute:"collection",property:"prefLabel",searchTextSuffix:"*",searchFromRoot:l,onSelect:function(o,n){d.jumpToClass(o["@id"]);n.val("")},minCharacters:3,additionalParameters:{apikey:d.option.apikey,no_context:true,ontologies:d.option.ontology}});a(b).append(m);a(b).append(d);d.addClass(d.option.treeClass);d.formatNodes=function(n){var p=a("<span>");var o=a("<ul>");n.sort(function(r,q){var t=r.prefLabel.toLowerCase();var s=q.prefLabel.toLowerCase();return((t<s)?-1:((t>s)?1:0))});a.each(n,function(u,r){var x=a("<li>");var w=a("<a>").attr("href",d.determineHTTPS(r.links.self)).html(r.prefLabel);w.attr("data-id",encodeURIComponent(r["@id"]));o.append(x.append(w));var s=typeof r.children!=="undefined"&&r.childrenCount>0&&r.children.length==0;if(r.childrenCount>0&&typeof r.children==="undefined"||s){var v=a("<ul>").addClass("ajax");var y=a("<li>");var q=a("<a>").attr("href",r.links.children);x.append(v.append(y.append(q)))}else{if(typeof r.children!=="undefined"&&r.children.length>0){var t=d.formatNodes(r.children);x.attr("class","folder-open");x.append(t)}}});p.append(o);return p.html()};d.findRootNode=function(p){var r=(d.option.startingRoot==d.option.defaultRoot)?null:d.option.startingRoot;if(r==null){return p}var o=false;var n=p;while(n.length>0||o==false){var q=n.shift();if(q["@id"]==r){o=[q]}else{if(typeof q.children!=="undefined"&&q.children.length>0){n=n.concat(q.children)}}}return o};d.jumpToClass=function(n,o){e.html(a("<span>").html("Loading...").css("font-size","smaller"));a.ajax({url:d.determineHTTPS(d.option.ncboAPIURL)+"/ontologies/"+d.option.ontology+"/classes/"+encodeURIComponent(n)+"/tree",data:{apikey:d.option.apikey,include:"prefLabel,childrenCount",no_context:true},contentType:"json",crossDomain:true,success:function(p){p=d.findRootNode(p);e.html(d.formatNodes(p));d.setTreeNodes(e,false);if(typeof o=="function"){o()}b.selectClass(n);if(typeof d.option.afterJumpToClass=="function"){d.option.afterJumpToClass(n)}b.trigger("afterJumpToClass",n)}})};d.closeNearby=function(n){a(n).siblings().filter(".folder-open, .folder-open-last").each(function(){var o=a(">ul",this);var p=this.className;this.className=p.replace("open","close");o.hide()})};d.nodeToggle=function(o){var n=a(">ul",o);if(n.is(":visible")){o.className=o.className.replace("open","close");n.hide()}else{o.className=o.className.replace("close","open");n.show();if(d.option.autoclose){d.closeNearby(o)}if(n.is(".ajax")){d.setAjaxNodes(n,o.id)}}};d.setAjaxNodes=function(q,r,n,o){if(typeof d.option.beforeExpand=="function"){d.option.beforeExpand(q)}b.trigger("beforeExpand",q);var p=a.trim(a("a",q).attr("href"));if(p){a.ajax({type:"GET",url:p,data:{apikey:d.option.apikey,include:"prefLabel,childrenCount",no_context:true},crossDomain:true,contentType:"json",timeout:d.option.timeout,success:function(t){var s=d.formatNodes(t.collection);q.removeAttr("class");q.html(s);a.extend(q,{url:p});d.setTreeNodes(q,true);if(typeof d.option.afterExpand=="function"){d.option.afterExpand(q)}b.trigger("afterExpand",q);if(typeof n=="function"){n(q)}},error:function(s){if(typeof d.option.afterExpandError=="function"){d.option.afterExpandError(q)}if(typeof o=="function"){o(q)}b.trigger("afterExpandError",q)}})}};d.setTreeNodes=function(o,n){o=n?o.parent():o;a("li>a",o).addClass("text").bind("selectstart",function(){return false}).click(function(){var p=a(this).parent();var q=a(this);a(".active",d).attr("class","text");if(this.className=="text"){this.className="active"}if(typeof d.option.afterSelect=="function"){d.option.afterSelect(decodeURIComponent(q.data("id")),q.text(),q)}b.trigger("afterSelect",[decodeURIComponent(q.data("id")),q.text(),q]);return false}).bind("contextmenu",function(){a(".active",d).attr("class","text");if(this.className=="text"){this.className="active"}if(typeof d.option.afterContextMenu=="function"){d.option.afterContextMenu(parent)}return false}).mousedown(function(q){g=true;cloneNode=a(this).parent().clone();var p=a(this).parent();return false});a("li",o).each(function(t){var u=this.className;var r=false;var q=false;var p=this;var s=a(">ul",this);if(s.size()>0){var v="folder-";if(u&&u.indexOf("open")>=0){v=v+"open";r=true}else{v=v+"close"}this.className=v+(a(this).is(":last-child")?"-last":"");if(!r||u.indexOf("ajax")>=0){s.hide()}d.setTrigger(this)}else{var v="doc";this.className=v+(a(this).is(":last-child")?"-last":"")}}).before('<li class="line">&nbsp;</li>').filter(":last-child").after('<li class="line-last"></li>')};d.setTrigger=function(o){a(">a",o).before('<img class="trigger" src="data:image/gif;base64,R0lGODlhAQABAID/AMDAwAAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==" border=0>');var n=a(">.trigger",o);n.click(function(p){d.nodeToggle(o)})};d.checkNodeIsLast=function(n){if(n.className.indexOf("last")>=0){n.className=n.className.replace("-last","")}};d.checkLineIsLast=function(n){if(n.className.indexOf("last")>=0){var o=a(n).prev();if(o.size()>0){o[0].className=o[0].className.replace("-last","")}dragNode_source[0].className+="-last"}};d.convertToFolder=function(n){n[0].className=n[0].className.replace("doc","folder-open");n.append('<ul><li class="line-last"></li></ul>');d.setTrigger(n[0]);d.setEventLine(a(".line, .line-last",n))};d.convertToDoc=function(n){a(">ul",n).remove();a("img",n).remove();n[0].className=n[0].className.replace(/folder-(open|close)/gi,"doc")};d.addNode=function(r,p,n,q){var o=a('<li><ul><li id="'+r+'"><a href="'+n+'">'+p+"</a></li></ul></li>");d.setTreeNodes(o);dragNode_destination=d.getSelected();dragNode_source=a(".doc-last",o);d.moveNodeToFolder(dragNode_destination);o.remove();if(typeof(q)=="function"){q(dragNode_destination,dragNode_source)}};d.delNode=function(n){dragNode_source=d.getSelected();d.checkNodeIsLast(dragNode_source[0]);dragNode_source.prev().remove();dragNode_source.remove();if(typeof(n)=="function"){n(dragNode_destination)}};d.determineHTTPS=function(n){return n.replace("http:",("https:"==document.location.protocol?"https:":"http:"))};d.init=function(){if(d.option.startingClass!==null){d.jumpToClass(d.option.startingClass);d.option.startingClass=null}else{a.ajax({url:d.determineHTTPS(d.option.ncboAPIURL)+"/ontologies/"+d.option.ontology+"/classes/"+encodeURIComponent(d.option.startingRoot),data:{apikey:d.option.apikey,include:"prefLabel,childrenCount",no_context:true},contentType:"json",crossDomain:true,success:function(n){n=a.map([n],function(o){return o});e.append(d.formatNodes(n));d.setTreeNodes(e,false)}})}}};return this.each(function(){var h=this;a.ajax({url:d.option.ncboUIURL.replace("http:",("https:"==document.location.protocol?"https:":"http:"))+"/widgets/jquery.ncbo.autocomplete.js",type:"GET",crossDomain:true,dataType:"script",success:function(){setupTree(h,d,d.option);d.init()}})})}}(jQuery));