<% require 'ostruct' %>

<%@title = "Ontology Recommender"%>

<script type="text/javascript">
	jQuery(document).ready(function(){
		jQuery("#recommender_button").click(getRecommendations);
	});
	
	function getRecommendations() {
		jQuery(".recommender_error").html("");
		jQuery(".recommender_spinner").show();
		
		var ont_select = jQuery("#ontology_ontologyId");
		
		var ontology_ids = (ont_select.val() == null) ? "" : ont_select.val().join(",")
		
		jQuery.ajax({
          type: "POST",
          url: "/recommender?text="+jQuery("#recommendation_text").val()+"&ontology_ids="+ontology_ids,
          dataType: "json",
          success: function(data) {
            jQuery(".recommender_spinner").hide();

            // Really dumb, basic word counter. Counts spaces.
            if (jQuery("#recommendation_text").val().match(/ /g) == null || jQuery("#recommendation_text").val().match(/ /g).length < 50) {
              jQuery("#not_enough_text_error").html("Please use more than 50 words for accurate results");
            }

            var links = [];
            links.push('<tr><td valign=bottom style="font-size: large; padding-bottom: 7px;"><b>Ontology Recommendations</b></td><td valign=bottom style="padding: 0 0 9px 1em; text-align: right;">Terms<br/>Matched</td></tr>');
            
            if (jQuery.isEmptyObject(data)) {
            	links.push("<tr><td>No recommendations found</td></tr>");
            } else {
	            jQuery(data).each(function(){
	            	var rec = this;
	            	links.push("<tr><td style='padding: 3px;'><a href='/ontologies/"+rec.virtualOntologyId+"'>"+rec.name+"</a></td><td style='text-align: right;'>"+rec.nbAnnotation+"</td></tr>");
	            });
            }
            
            jQuery("#recommendations").html(links.join(""));
            jQuery("#recommendations_container").show();
          },
          error: function(data) {
            jQuery("#recommendations_container").hide();
            jQuery(".recommender_spinner").hide();
            jQuery(".recommender_error").html(" Problem getting recommendations, please try again");
          }
    });
	}
</script>

<div style="padding: 1em;">
	<h1>Ontology Recommender</h1>
	
	<p>Enter text below. The Ontology Recommender will analyze this text and provide a ranked list of ontologies that are relevant.</p>

  <div style="float: left; padding-bottom: 1em;">
    <% textarea_title = "Please paste at least a paragraph (50 words or more) of text to use in calculating ontology recommendations" %>
    <%=text_area :recommendation, :text, :title => textarea_title, :rows => 15, :style => "box-shadow: 0 0 3px gray; padding: 5px; width: 600px;", :class => "help_text" %>

		<br style="margin-bottom: 10px;"/>
		
		<%=render :partial => "shared/ontology_picker"%>

		<input type="button" id="recommender_button" value="Get Recommendations" style="margin-top: 10px;">
		<span class="recommender_spinner" style="display: none;"><img src="/images/spinners/spinner_000000_16px.gif" style="vertical-align: text-bottom;"></span>
		<span style='color: red;' class='recommender_error'></span>
	</div>
	
	<div id="recommendations_container" style="display: none; padding: 1em; margin: 0 1em 2em; border: thin solid gray; float: left; box-shadow: 0 0 3px gray;">
    <div id="not_enough_text_error" style="color: red; margin-bottom: 7px;"></div>
    <table id="recommendations" style="display: inline-block;"></table>
	</div>

</div>
