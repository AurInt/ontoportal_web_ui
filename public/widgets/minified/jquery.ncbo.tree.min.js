(function(a){a.fn.NCBOTree=function(c){var b=this;var d=a("<ul>").append(a("<li>").addClass("root"));var e;var f=false;d.option={autoclose:false,beforeExpand:false,afterExpand:false,afterExpandError:false,afterSelect:false,afterJumpToClass:false,timeout:999999,treeClass:"ncboTree",autocompleteClass:"ncboAutocomplete",width:350,ncboAPIURL:"http://data.bioontology.org",ncboUIURL:"http://bioportal.bioontology.org",apikey:null,ontology:null,startingClass:null};d.option=a.extend(d.option,c);a.ajax({url:d.option.ncboUIURL+"/widgets/jquery.ncbo.autocomplete.js",type:"GET",async:false,dataType:"script"});if(d.option.apikey==null){throw new Error("You must provide an API Key for NCBO Tree Widget to operate")}if(d.option.ontology==null){throw new Error("You must provide an ontology id for NCBO Tree Widget to operate")}a.extend(this,{selectedClass:function(){var g=a(a(this).find("a.active")[0]);if(g.length==0){return null}else{return{id:decodeURIComponent(g.data("id")),prefLabel:g.html(),URL:g.attr("href")}}},selectClass:function(g){var h=a(a(this).find("a[data-id='"+encodeURIComponent(g)+"']"));a(a(this).find("a.active")[0]).removeClass("active");h.addClass("active")},jumpToClass:function(g,h){d.jumpToClass(g,h)},changeOntology:function(g){var h=a("<ul>").append(a("<li>").addClass("root"));setupTree(b,h,d.option);d.option.ontology=g;d.init()}});setupTree=function(h,g,j){d=g;d.option=j;e=a(".root",d);d.css("width",d.option.width);a(b).html("");var k=a("<div>").addClass(d.option.autocompleteClass).addClass("ncboTree");var i=a("<input>").addClass(d.option.autocompleteClass).css("width",d.option.width).attr("placeholder","Search for class...");k.append(i);i.NCBOAutocomplete({url:d.option.ncboAPIURL+"/search",searchParameter:"q",resultAttribute:"collection",property:"prefLabel",searchTextSuffix:"*",onSelect:function(m,l){d.jumpToClass(m["@id"]);l.val("")},minCharacters:3,additionalParameters:{apikey:d.option.apikey,no_context:true,ontologies:d.option.ontology}});a(b).append(k);a(b).append(d);d.addClass(d.option.treeClass);d.formatNodes=function(l){var n=a("<span>");var m=a("<ul>");l.sort(function(p,o){var r=p.prefLabel.toLowerCase();var q=o.prefLabel.toLowerCase();return((r<q)?-1:((r>q)?1:0))});a.each(l,function(s,p){var v=a("<li>");var u=a("<a>").attr("href",p.links.self).html(p.prefLabel);u.attr("data-id",encodeURIComponent(p["@id"]));m.append(v.append(u));var q=typeof p.children!=="undefined"&&p.childrenCount>0&&p.children.length==0;if(p.childrenCount>0&&typeof p.children==="undefined"||q){var t=a("<ul>").addClass("ajax");var w=a("<li>");var o=a("<a>").attr("href",p.links.children);v.append(t.append(w.append(o)))}else{if(typeof p.children!=="undefined"&&p.children.length>0){var r=d.formatNodes(p.children);v.attr("class","folder-open");v.append(r)}}});n.append(m);return n.html()};d.jumpToClass=function(l,m){e.html(a("<span>").html("Loading...").css("font-size","smaller"));a.ajax({url:d.option.ncboAPIURL+"/ontologies/"+d.option.ontology+"/classes/"+encodeURIComponent(l)+"/tree",data:{apikey:d.option.apikey,include:"prefLabel,childrenCount",no_context:true},contentType:"json",crossDomain:true,success:function(n){e.html(d.formatNodes(n));d.setTreeNodes(e,false);if(typeof m=="function"){m()}b.selectClass(l);if(typeof d.option.afterJumpToClass=="function"){d.option.afterJumpToClass(l)}b.trigger("afterJumpToClass",l)}})};d.closeNearby=function(l){a(l).siblings().filter(".folder-open, .folder-open-last").each(function(){var m=a(">ul",this);var n=this.className;this.className=n.replace("open","close");m.hide()})};d.nodeToggle=function(m){var l=a(">ul",m);if(l.is(":visible")){m.className=m.className.replace("open","close");l.hide()}else{m.className=m.className.replace("close","open");l.show();if(d.option.autoclose){d.closeNearby(m)}if(l.is(".ajax")){d.setAjaxNodes(l,m.id)}}};d.setAjaxNodes=function(o,p,l,m){if(typeof d.option.beforeExpand=="function"){d.option.beforeExpand(o)}b.trigger("beforeExpand",o);var n=a.trim(a("a",o).attr("href"));if(n){a.ajax({type:"GET",url:n,data:{apikey:d.option.apikey,include:"prefLabel,childrenCount",no_context:true},crossDomain:true,contentType:"json",timeout:d.option.timeout,success:function(r){var q=d.formatNodes(r.collection);o.removeAttr("class");o.html(q);a.extend(o,{url:n});d.setTreeNodes(o,true);if(typeof d.option.afterExpand=="function"){d.option.afterExpand(o)}b.trigger("afterExpand",o);if(typeof l=="function"){l(o)}},error:function(q){if(typeof d.option.afterExpandError=="function"){d.option.afterExpandError(o)}if(typeof m=="function"){m(o)}b.trigger("afterExpandError",o)}})}};d.setTreeNodes=function(m,l){m=l?m.parent():m;a("li>a",m).addClass("text").bind("selectstart",function(){return false}).click(function(){var n=a(this).parent();var o=a(this);a(".active",d).attr("class","text");if(this.className=="text"){this.className="active"}if(typeof d.option.afterSelect=="function"){d.option.afterSelect(decodeURIComponent(o.data("id")),o.text(),o)}b.trigger("afterSelect",[decodeURIComponent(o.data("id")),o.text(),o]);return false}).bind("contextmenu",function(){a(".active",d).attr("class","text");if(this.className=="text"){this.className="active"}if(typeof d.option.afterContextMenu=="function"){d.option.afterContextMenu(parent)}return false}).mousedown(function(o){f=true;cloneNode=a(this).parent().clone();var n=a(this).parent();return false});a("li",m).each(function(r){var s=this.className;var p=false;var o=false;var n=this;var q=a(">ul",this);if(q.size()>0){var t="folder-";if(s&&s.indexOf("open")>=0){t=t+"open";p=true}else{t=t+"close"}this.className=t+(a(this).is(":last-child")?"-last":"");if(!p||s.indexOf("ajax")>=0){q.hide()}d.setTrigger(this)}else{var t="doc";this.className=t+(a(this).is(":last-child")?"-last":"")}}).before('<li class="line">&nbsp;</li>').filter(":last-child").after('<li class="line-last"></li>')};d.setTrigger=function(m){a(">a",m).before('<img class="trigger" src="data:image/gif;base64,R0lGODlhAQABAID/AMDAwAAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==" border=0>');var l=a(">.trigger",m);l.click(function(n){d.nodeToggle(m)})};d.checkNodeIsLast=function(l){if(l.className.indexOf("last")>=0){l.className=l.className.replace("-last","")}};d.checkLineIsLast=function(l){if(l.className.indexOf("last")>=0){var m=a(l).prev();if(m.size()>0){m[0].className=m[0].className.replace("-last","")}dragNode_source[0].className+="-last"}};d.convertToFolder=function(l){l[0].className=l[0].className.replace("doc","folder-open");l.append('<ul><li class="line-last"></li></ul>');d.setTrigger(l[0]);d.setEventLine(a(".line, .line-last",l))};d.convertToDoc=function(l){a(">ul",l).remove();a("img",l).remove();l[0].className=l[0].className.replace(/folder-(open|close)/gi,"doc")};d.addNode=function(p,n,l,o){var m=a('<li><ul><li id="'+p+'"><a href="'+l+'">'+n+"</a></li></ul></li>");d.setTreeNodes(m);dragNode_destination=d.getSelected();dragNode_source=a(".doc-last",m);d.moveNodeToFolder(dragNode_destination);m.remove();if(typeof(o)=="function"){o(dragNode_destination,dragNode_source)}};d.delNode=function(l){dragNode_source=d.getSelected();d.checkNodeIsLast(dragNode_source[0]);dragNode_source.prev().remove();dragNode_source.remove();if(typeof(l)=="function"){l(dragNode_destination)}};d.init=function(){if(d.option.startingClass!==null){d.jumpToClass(d.option.startingClass);d.option.startingClass=null}else{a.ajax({url:d.option.ncboAPIURL+"/ontologies/"+d.option.ontology+"/classes/roots",data:{apikey:d.option.apikey,include:"prefLabel,childrenCount",no_context:true},contentType:"json",crossDomain:true,success:function(l){e.append(d.formatNodes(l));d.setTreeNodes(e,false)}})}}};return this.each(function(){setupTree(this,d,d.option);d.init()})}}(jQuery));